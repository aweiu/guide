# Regular 在微信小程序中的使用

随着最近一段时间微信小程序的大火，很多公司开始重视起了微信小程序上面的开发投入，甚至出现了很多类似小程序的平台，比如快应用、百度小程序、支付宝小程序等等

（注：下文提到的小程序皆指微信小程序）

## 理论基础

为什么 Regular 代码可以跑在小程序平台上？

让我们先来看下微信小程序的整体架构

```
+--------------+    +---------------+
|     View     |    |  App Service  |
+----^---+-----+    +-----^---------+
     |   |                |   |
data |   | event    event |   | data
     |   |                |   |
+----+---v----------------+---v-----+
|              JSBridge             |
+-----------------------------------+
```

View 对应视图层，App Service 对应我们的逻辑层

View 和 AppService 分别跑在两个线程中，通过 JSBridge 进行数据和事件的通信

### 限制

按照小程序本身的语法，模板是需要事先写好的，而不能通过类似 DOM api 这样的方式在运行时去操作视图层

### 实现思路

但换言之，由于事先写好了模板，事件的绑定关系和数据坑位，View 都帮我们预先留好了

举个例子（伪代码）：

```html
<view
  bindtap="eventHandler"
  data-cid="component-id"
  data-eid="event-id"
>
  Hello {{ _holders[ 'some-id' ] }}
</view>
```

```js
Regular.extend( {
  config() {
    this.data.name = 'world'
  },
  onClick() {
    console.log( 'clicked' )
  }
} )
```

1. 数据填充

  我们只要通过一定规则找到这些坑位的 `some-id` 标识，就可以将`name`填充到模板的对应位置上

2. 事件处理

  当 tap 触发的时候会执行 `eventHandler`，在 `eventHandler` 中通过 `component-id` 找到对应的 `Regular 实例`，再通过event-id找到对应的真实事件处理函数

### 为什么设计 holders，而不传递真正的数据呢？

虽然直接看 holders，感觉平平无奇，但其实这是 mpregular 中`最重要的一个设计`

- 全量的复杂表达式支持

  借助 holders，我们完成了 Regular 所有复杂表达式的支持。由于逻辑层提前将所有数据计算并剥离出来，放到了一个扁平的数据结构中，__所以我们不再需要 小程序视图层 提供这些表达式特性的支持，完全摆脱了小程序模板本身的限制__，现在的 View 只会被用来做纯粹的渲染

- 更高效的视图渲染

  根据我们的实践，__当调用小程序的 setData 时，如果 View 层接收的数据量过大，会导致渲染时的明显卡顿__，原因可能是 View 层 diff 的数据量过大导致，在传递数据过程中有一个大列表带了很多冗余的数据过去，而这点通过警告开发者不要这么做，是很难保证的，后端经常会传输一些冗余字段到前端，比如一个数组中真正用于渲染的其实只是部分字段，如果每次都是人工通过代码过滤模板真正用到的字段，代码将会很难维护，针对这块，如果我们把数据全部抽离出来并展平，每个数据坑位都能通过某个id拿到自己数据，就能做到更高效的更新，用食堂大叔的话说就是__吃多少拿多少__

### 总结

只要模板是可以静态分析的，提前将 __数据坑位查找规则__ 和 __事件处理函数查找规则__ 在构建阶段生成到 wxml 中，到了运行时阶段，小程序的视图层和逻辑层自然就可以无缝衔接起来了
